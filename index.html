<!DOCTYPE html>
<html lang="en">
  <head>
    <title>BongcloudChess</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="BongcloudChess.js"></script>
    <style>
      body {
      background: #181818;
      }
      .board {
        margin: 0px;
        padding: 0px;
      }
      body, html { margin: 0px;}
    </style>
  </head>  
<body>
<span id="container"></span>

<canvas id="board" style="border:none; display: block; margin-left: auto; margin-right: auto;"> </canvas>
<script>  
const canvas = document.getElementById("board");
var wp = new Image();
wp.src = "/pawnwhite.png";
var bp = new Image();
bp.src = "/pawnblack.png";
var wk = new Image();
wk.src = "/kingwhite.png";
var bk = new Image();
bk.src = "/kingblack.png";

window.addEventListener('resize', function() {
  resizeCanvas();
  refresh();
});

function resizeCanvas() {
  canvas.width = Math.min(window.innerHeight, window.innerWidth);
  canvas.height = canvas.width;
  tileSize = canvas.width / 8; 
}

GetBoard = Module.cwrap('get_board', 'string', [null]);

AiMove = Module.cwrap('ai_move', null, ['number']);
UserMove = Module.cwrap('user_move', 'number', ['number', 'number']);
GetSquares = Module.cwrap('get_squares', null, ['number', 'number']);
IsTerminal = Module.cwrap('is_mainboard_terminal', 'number', [null]);

Module['onRuntimeInitialized'] = onRuntimeInitialized;
function onRuntimeInitialized() {
  Module.ccall('init_board', null, [null], []);
  //Module.ccall('main', 'number', [null], [])
  resizeCanvas();
  refresh();
}

function refresh() {
  var board = GetBoard().slice(0, -1);
  DrawBoard(canvas, board);
}

function DrawBoard(can, board) {
  var ctx = can.getContext("2d");
  var w = can.width;
  var h = can.height;
  ctx.fillStyle = "#cfcfcf";
  ctx.fillRect(0, 0, w, h);

  nRow = nCol = 8;

  w /= nCol;
  h /= nRow;           

  for (var i = 0; i < nRow; ++i) {
    for (var j = 0; j < nCol; ++j) {
      if (j % 2 == 0) {
          ctx.fillStyle = "#614796";
          ctx.fillRect(j * w + (i % 2 ? 0 : w), i * h, w, h);
      }
      
      var char = board[i*8+j];
      if (char != '.') { DrawImage(char, ctx, j * w, i * h, w, h);}
    }
  }
  ctx.strokeStyle = "#3f3f3f";
  ctx.lineWidth = "5";
  ctx.beginPath();
  ctx.rect(0, 0, can.width, can.height);
  ctx.stroke();
  ctx.strokeStyle = "#000"
}

function DrawImage(char, ctx, x1, y1, x2, y2) {
  if (char == 'p') {
    ctx.drawImage(bp, x1, y1, x2, y2);
  } else if (char == 'P') {
    ctx.drawImage(wp, x1, y1, x2, y2);
  } else if (char == 'k') {
    ctx.drawImage(bk, x1, y1, x2, y2);
  } else if (char == 'K') {
    ctx.drawImage(wk, x1, y1, x2, y2);
  }
}

var move = new Int8Array(2);
var depth = 5;
var tileSize = canvas.width / 8;
function DrawMove(can, xSquare, ySquare) {
  var piece = GetBoard().slice(0, -1)[ySquare*8+xSquare];
  
  if (piece == piece.toUpperCase() && piece != '.') {
    refresh();
    var ctx = can.getContext("2d");
    ctx.lineWidth = "3";
    
    ctx.fillStyle = "#241430";
    ctx.fillRect(xSquare * tileSize, ySquare * tileSize, tileSize, tileSize);
    DrawImage(piece, ctx, xSquare * tileSize, ySquare * tileSize, tileSize, tileSize);
    
    move[0] = ySquare*8+xSquare;
    var offset = Module._malloc(5*4)
    var squares = Module.HEAP32.subarray(offset/4, offset/4 + 5);
    GetSquares(move[0], offset);
    ctx.beginPath();
    ctx.rect(xSquare * tileSize, ySquare * tileSize, tileSize, tileSize);
    ctx.stroke();
    for (i = 0; i < 5; i++) { 
      if (squares[i] != -1) {
        xSquare = squares[i] % 8;
        ySquare = Math.floor(squares[i] / 8);
        ctx.beginPath();
        ctx.rect(xSquare * tileSize, ySquare * tileSize, tileSize, tileSize);
        ctx.stroke();
        ctx.globalAlpha = 0.2;
        ctx.fillStyle = "#fc03ec";
        ctx.fillRect(xSquare * tileSize, ySquare * tileSize, tileSize, tileSize);
        ctx.globalAlpha = 1;
      }
    }
    Module._free(offset);
  } else {
    move[1] = ySquare*8+xSquare;
    var valid = UserMove(move[0], move[1]); 
    requestAnimationFrame(refresh);
    if (valid == 1) {
      canvas.style.cursor = 'wait';
      if (endGame()) {return;}
      setTimeout(MakeAiMove, 30);
    }
  }
}

function MakeAiMove() {
  var start = Date.now();  
      var start = Date.now();
  var start = Date.now();  
  AiMove(depth);
  if (Date.now() - start < 300) {depth++;}
  canvas.style.cursor = 'default';
  refresh();
  endGame();
}

function endGame() {
  if (IsTerminal() == 1) {
    refresh();
    setTimeout(function(){ 
      var score = Module.ccall('score_mainboard', 'number', [null], []);
      if (score == 1) {
        alert("White Wins!");
      } else if (score == -1) {
        alert("Black Wins!");
      } else {
        alert("Draw!");
      }
      location.reload();
    }, 0);
    return true;
  }
  return false;
}

function movePiece(canvas, event) {
    const rect = canvas.getBoundingClientRect()
    const x = event.clientX - rect.left
    const y = event.clientY - rect.top
    var tileSize = canvas.width / 8;
    var xSquare = Math.floor(x / tileSize);
    var ySquare = Math.floor(y / tileSize);
    
    DrawMove(canvas, xSquare, ySquare);
}


canvas.addEventListener('mousedown', function(e) {
    movePiece(canvas, e)
})

</script>
</body>
</html>